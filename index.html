<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Digiconnect - Subscription Manager</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; min-height: 100vh; background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%); color: #fff; }
    
    /* Auth Page Styles */
    .auth-page { position: fixed; inset: 0; background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%); display: flex; align-items: center; justify-content: center; z-index: 5000; }
    .auth-page.hidden { display: none; }
    .auth-container { background: rgba(255,255,255,0.05); backdrop-filter: blur(20px); border-radius: 24px; padding: 48px; width: 90%; max-width: 420px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 25px 50px rgba(0,0,0,0.5); text-align: center; }
    .auth-logo { background: linear-gradient(135deg, #e31837 0%, #ff4757 100%); width: 80px; height: 80px; border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; box-shadow: 0 8px 25px rgba(227, 24, 55, 0.4); }
    .auth-title { font-size: 1.8rem; font-weight: 800; background: linear-gradient(135deg, #fff 0%, #e31837 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 8px; }
    .auth-subtitle { color: rgba(255,255,255,0.5); font-size: 0.9rem; margin-bottom: 32px; }
    .auth-form { display: flex; flex-direction: column; gap: 16px; }
    .auth-input-group { position: relative; text-align: left; }
    .auth-input-group label { display: block; font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-bottom: 6px; }
    .auth-input { width: 100%; padding: 14px 16px; border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; background: rgba(255,255,255,0.05); color: white; font-size: 1rem; transition: all 0.3s ease; font-family: inherit; }
    .auth-input:focus { outline: none; border-color: #e31837; box-shadow: 0 0 20px rgba(227, 24, 55, 0.2); }
    .auth-input::placeholder { color: rgba(255,255,255,0.4); }
    .auth-btn { background: linear-gradient(135deg, #e31837 0%, #ff4757 100%); color: white; border: none; padding: 16px 24px; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-family: inherit; }
    .auth-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(227, 24, 55, 0.4); }
    .auth-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .auth-error { color: #ff4757; font-size: 0.85rem; padding: 12px; background: rgba(255, 71, 87, 0.1); border-radius: 8px; border: 1px solid rgba(255, 71, 87, 0.3); text-align: left; }
    .auth-error.hidden { display: none; }
    .auth-footer { margin-top: 24px; color: rgba(255,255,255,0.3); font-size: 0.75rem; }
    .password-toggle { position: absolute; right: 14px; top: 38px; background: none; border: none; color: rgba(255,255,255,0.5); cursor: pointer; font-size: 1.1rem; }

    /* User Info & Menu */
    .user-info { display: flex; align-items: center; gap: 12px; }
    .user-email { font-size: 0.85rem; color: rgba(255,255,255,0.7); max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .user-menu-btn { background: rgba(255,255,255,0.1); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-family: inherit; display: flex; align-items: center; gap: 8px; }
    .user-menu-btn:hover { background: rgba(255,255,255,0.2); }
    .user-dropdown { position: absolute; top: 100%; right: 0; margin-top: 8px; background: rgba(26, 26, 46, 0.98); backdrop-filter: blur(20px); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); padding: 8px; min-width: 200px; z-index: 100; display: none; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
    .user-dropdown.show { display: block; }
    .user-dropdown-item { display: flex; align-items: center; gap: 10px; padding: 12px 16px; border-radius: 8px; color: rgba(255,255,255,0.7); font-size: 0.9rem; cursor: pointer; transition: all 0.2s ease; border: none; background: none; width: 100%; text-align: left; font-family: inherit; }
    .user-dropdown-item:hover { background: rgba(255,255,255,0.1); color: white; }
    .user-dropdown-item.danger { color: #ff4757; }
    .user-dropdown-divider { height: 1px; background: rgba(255,255,255,0.1); margin: 8px 0; }
    .user-dropdown-email { padding: 12px 16px; color: rgba(255,255,255,0.5); font-size: 0.8rem; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 8px; word-break: break-all; }
    .user-menu-container { position: relative; }

    /* Main App Styles */
    .app-container { display: none; }
    .app-container.visible { display: block; }
    
    .header { padding: 24px 40px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .header-content { display: flex; align-items: center; justify-content: space-between; max-width: 1400px; margin: 0 auto; flex-wrap: wrap; gap: 20px; }
    .logo-section { display: flex; align-items: center; gap: 12px; }
    .logo-icon { background: linear-gradient(135deg, #e31837 0%, #ff4757 100%); width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 25px rgba(227, 24, 55, 0.4); }
    .logo-text h1 { font-size: 1.8rem; font-weight: 800; background: linear-gradient(135deg, #fff 0%, #e31837 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .logo-text p { font-size: 0.75rem; color: rgba(255,255,255,0.5); letter-spacing: 2px; }
    .nav { display: flex; gap: 12px; flex-wrap: wrap; }
    .nav-btn { padding: 12px 24px; border: none; border-radius: 12px; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; font-family: inherit; background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.7); }
    .nav-btn:hover { background: rgba(255,255,255,0.15); color: white; }
    .nav-btn.active { background: linear-gradient(135deg, #e31837 0%, #ff4757 100%); color: white; box-shadow: 0 8px 25px rgba(227, 24, 55, 0.4); transform: translateY(-2px); }
    .main { padding: 32px 40px; max-width: 1400px; margin: 0 auto; }
    .service-tabs { margin-bottom: 20px; display: flex; gap: 12px; flex-wrap: wrap; }
    .service-tab { padding: 10px 20px; border: none; border-radius: 25px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-family: inherit; background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.6); }
    .service-tab:hover { background: rgba(255,255,255,0.2); }
    .service-tab.active { color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.3); transform: scale(1.05); }
    .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .summary-card { background: rgba(255,255,255,0.05); border-radius: 16px; padding: 20px; border: 1px solid rgba(255,255,255,0.1); position: relative; overflow: hidden; }
    .summary-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; }
    .summary-card.danger::before { background: #ff4757; }
    .summary-card.warning::before { background: #ffc107; }
    .summary-card.success::before { background: #2ed573; }
    .summary-card.info::before { background: #6495ed; }
    .summary-card-value { font-size: 2rem; font-weight: 700; margin-bottom: 4px; }
    .summary-card-label { font-size: 0.85rem; color: rgba(255,255,255,0.5); }
    .search-filter-bar { display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; }
    .search-box { flex: 1; min-width: 200px; position: relative; }
    .search-input { width: 100%; padding: 12px 16px 12px 44px; border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; background: rgba(255,255,255,0.05); color: white; font-size: 0.95rem; transition: all 0.3s ease; font-family: inherit; }
    .search-input:focus { outline: none; border-color: #e31837; box-shadow: 0 0 20px rgba(227, 24, 55, 0.2); }
    .search-input::placeholder { color: rgba(255,255,255,0.4); }
    .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: rgba(255,255,255,0.4); }
    .filter-select { padding: 12px 16px; border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; background: rgba(255,255,255,0.05); color: white; font-size: 0.85rem; font-family: inherit; cursor: pointer; min-width: 130px; }
    .filter-select option { background: #1a1a2e; color: white; }
    .clear-filters-btn { padding: 12px 16px; border: none; border-radius: 12px; background: rgba(255, 71, 87, 0.2); color: #ff4757; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-family: inherit; }
    .bulk-actions-bar { display: flex; gap: 12px; margin-bottom: 16px; padding: 16px; background: rgba(100, 149, 237, 0.1); border-radius: 12px; border: 1px solid rgba(100, 149, 237, 0.3); align-items: center; flex-wrap: wrap; }
    .bulk-actions-bar.hidden { display: none; }
    .bulk-count { font-weight: 600; color: #6495ed; margin-right: 8px; }
    .bulk-btn { padding: 8px 16px; border: none; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-family: inherit; display: flex; align-items: center; gap: 6px; }
    .bulk-btn.renew { background: rgba(46, 213, 115, 0.2); color: #2ed573; }
    .bulk-btn.delete { background: rgba(255, 71, 87, 0.2); color: #ff4757; }
    .bulk-btn.reassign { background: rgba(100, 149, 237, 0.2); color: #6495ed; }
    .select-all-container { display: flex; align-items: center; gap: 8px; margin-left: auto; }
    .results-count { color: rgba(255,255,255,0.5); font-size: 0.85rem; padding: 8px 0; }
    .view-toggle { display: flex; gap: 4px; background: rgba(255,255,255,0.05); padding: 4px; border-radius: 10px; margin-bottom: 16px; }
    .view-toggle-btn { padding: 8px 16px; border: none; border-radius: 8px; background: transparent; color: rgba(255,255,255,0.5); font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-family: inherit; }
    .view-toggle-btn.active { background: rgba(255,255,255,0.1); color: white; }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
    .section-header h2 { font-size: 1.5rem; font-weight: 700; }
    .section-header p { color: rgba(255,255,255,0.5); margin-top: 4px; }
    .header-actions { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .btn-primary { background: linear-gradient(135deg, #e31837 0%, #ff4757 100%); color: white; border: none; padding: 12px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; font-family: inherit; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(227, 24, 55, 0.4); }
    .btn-secondary { background: rgba(255,255,255,0.1); color: white; border: none; padding: 12px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; font-family: inherit; }
    .btn-secondary:hover { background: rgba(255,255,255,0.2); }
    .btn-danger { background: rgba(255, 71, 87, 0.2); color: #ff4757; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
    .btn-success { background: rgba(46, 213, 115, 0.2); color: #2ed573; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
    .btn-edit { background: rgba(100, 149, 237, 0.2); color: #6495ed; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
    .btn-icon { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.7); border: none; padding: 8px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; }
    .btn-icon.whatsapp { background: rgba(37, 211, 102, 0.2); color: #25d366; }
    .card { background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); padding: 20px; transition: all 0.3s ease; margin-bottom: 16px; position: relative; overflow: hidden; }
    .card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; transition: background 0.3s ease; }
    .card.status-success::before { background: #2ed573; }
    .card.status-warning::before { background: #ffc107; }
    .card.status-danger::before { background: #ff4757; }
    .card.status-default::before { background: rgba(255,255,255,0.2); }
    .card:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.3); border-color: rgba(227, 24, 55, 0.3); }
    .card.selected { border-color: #6495ed; background: rgba(100, 149, 237, 0.1); }
    .card-empty { text-align: center; padding: 60px; }
    .card-empty p { color: rgba(255,255,255,0.5); }
    .customer-card { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 16px; }
    .card-checkbox { position: absolute; top: 16px; right: 16px; width: 20px; height: 20px; cursor: pointer; accent-color: #6495ed; }
    .customer-info { display: flex; gap: 16px; align-items: flex-start; }
    .customer-avatar { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .customer-details h3 { font-size: 1.1rem; font-weight: 600; margin-bottom: 4px; }
    .customer-meta { display: flex; align-items: center; gap: 12px; color: rgba(255,255,255,0.6); font-size: 0.9rem; flex-wrap: wrap; }
    .customer-meta span { display: flex; align-items: center; gap: 4px; }
    .not-available { color: rgba(255,255,255,0.35); font-style: italic; }
    .days-remaining { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
    .days-remaining.success { background: rgba(46, 213, 115, 0.2); color: #2ed573; }
    .days-remaining.warning { background: rgba(255, 193, 7, 0.2); color: #ffc107; }
    .days-remaining.danger { background: rgba(255, 71, 87, 0.2); color: #ff4757; }
    .progress-ring-container { position: relative; width: 50px; height: 50px; }
    .progress-ring { transform: rotate(-90deg); }
    .progress-ring-bg { fill: none; stroke: rgba(255,255,255,0.1); stroke-width: 4; }
    .progress-ring-fill { fill: none; stroke-width: 4; stroke-linecap: round; transition: stroke-dashoffset 0.3s ease; }
    .progress-ring-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.7rem; font-weight: 700; }
    .payment-status { display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
    .payment-status.paid { background: rgba(46, 213, 115, 0.2); color: #2ed573; }
    .payment-status.pending { background: rgba(255, 193, 7, 0.2); color: #ffc107; }
    .customer-notes { margin-top: 8px; padding: 8px 12px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 0.85rem; color: rgba(255,255,255,0.6); font-style: italic; }
    .customer-notes::before { content: 'üìù '; }
    .badges { margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .badge { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
    .badge-default { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.7); }
    .badge-info { background: rgba(100, 149, 237, 0.2); color: #6495ed; }
    .card-actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .quick-actions { display: flex; gap: 4px; margin-left: 8px; }
    .slot-progress { margin-top: 12px; }
    .slot-progress-label { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 6px; color: rgba(255,255,255,0.6); }
    .slot-progress-bar { height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; }
    .slot-progress-fill { height: 100%; border-radius: 4px; transition: width 0.3s ease; }
    .host-customers { margin-top: 16px; }
    .host-customers p { font-size: 0.85rem; color: rgba(255,255,255,0.5); margin-bottom: 8px; }
    .host-customer-tags { display: flex; gap: 8px; flex-wrap: wrap; }
    .host-customer-tag { background: rgba(255,255,255,0.1); padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; }
    .calendar-view { background: rgba(255,255,255,0.05); border-radius: 16px; padding: 20px; margin-bottom: 24px; }
    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .calendar-nav { display: flex; gap: 8px; }
    .calendar-nav button { background: rgba(255,255,255,0.1); border: none; color: white; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-family: inherit; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
    .calendar-day-header { text-align: center; padding: 8px; font-size: 0.8rem; color: rgba(255,255,255,0.5); font-weight: 600; }
    .calendar-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 8px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s ease; position: relative; }
    .calendar-day:hover { background: rgba(255,255,255,0.1); }
    .calendar-day.other-month { color: rgba(255,255,255,0.3); }
    .calendar-day.today { background: rgba(100, 149, 237, 0.2); border: 1px solid #6495ed; }
    .calendar-day.has-due { background: rgba(255, 193, 7, 0.2); }
    .calendar-day.has-overdue { background: rgba(255, 71, 87, 0.2); }
    .calendar-day-count { font-size: 0.6rem; position: absolute; bottom: 2px; background: #e31837; color: white; padding: 1px 5px; border-radius: 10px; }
    .timeline-view { background: rgba(255,255,255,0.05); border-radius: 16px; padding: 20px; margin-bottom: 24px; }
    .timeline-item { display: flex; gap: 16px; padding: 16px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .timeline-item:last-child { border-bottom: none; }
    .timeline-date { min-width: 80px; text-align: center; }
    .timeline-date-day { font-size: 1.5rem; font-weight: 700; }
    .timeline-date-month { font-size: 0.75rem; color: rgba(255,255,255,0.5); }
    .timeline-content { flex: 1; }
    .timeline-items { display: flex; flex-wrap: wrap; gap: 8px; }
    .timeline-chip { padding: 8px 16px; border-radius: 20px; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; }
    .timeline-chip.warning { background: rgba(255, 193, 7, 0.2); color: #ffc107; }
    .timeline-chip.danger { background: rgba(255, 71, 87, 0.2); color: #ff4757; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 32px; }
    .stat-card { background: rgba(255,255,255,0.05); border-radius: 16px; padding: 24px; border: 1px solid rgba(255,255,255,0.1); }
    .stat-card p:first-child { font-size: 0.85rem; color: rgba(255,255,255,0.5); margin-bottom: 8px; }
    .stat-card .stat-value { font-size: 2rem; font-weight: 700; }
    .stat-card .stat-sub { font-size: 0.75rem; color: rgba(255,255,255,0.4); margin-top: 4px; }
    .period-selector { display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; }
    .period-btn { padding: 10px 20px; border: 2px solid rgba(255,255,255,0.1); border-radius: 25px; background: transparent; color: rgba(255,255,255,0.6); font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-family: inherit; }
    .period-btn:hover { border-color: rgba(255,255,255,0.3); color: white; }
    .period-btn.active { background: linear-gradient(135deg, #e31837 0%, #ff4757 100%); border-color: transparent; color: white; }
    .trend-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 32px; }
    .trend-card { background: rgba(255,255,255,0.05); border-radius: 16px; padding: 24px; border: 1px solid rgba(255,255,255,0.1); }
    .trend-card-title { font-size: 0.9rem; color: rgba(255,255,255,0.6); margin-bottom: 8px; }
    .trend-card-value { font-size: 2rem; font-weight: 700; }
    .service-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 32px; }
    .service-card { background: rgba(255,255,255,0.05); border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); padding: 20px; }
    .service-card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; }
    .service-card-header span { font-weight: 600; }
    .service-card-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .service-card-row span:first-child { color: rgba(255,255,255,0.5); font-size: 0.85rem; }
    .service-card-row span:last-child { font-weight: 600; }
    .service-card-divider { border-top: 1px solid rgba(255,255,255,0.1); padding-top: 8px; margin-top: 4px; }
    .chart-section { background: rgba(255,255,255,0.05); border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); padding: 24px; margin-bottom: 24px; }
    .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
    .chart-header h3 { font-size: 1.2rem; font-weight: 600; }
    .select-field { padding: 14px 40px 14px 16px; border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; background: rgba(255,255,255,0.05); color: white; font-size: 1rem; cursor: pointer; font-family: inherit; }
    .select-field option { background: #1a1a2e; color: white; }
    .chart-container { height: 350px; display: flex; align-items: flex-end; justify-content: center; gap: 40px; padding: 20px; overflow-x: auto; }
    .chart-bar-group { display: flex; flex-direction: column; align-items: center; gap: 8px; }
    .chart-bars { display: flex; gap: 4px; align-items: flex-end; height: 250px; }
    .chart-bar { width: 30px; border-radius: 4px 4px 0 0; min-height: 4px; }
    .chart-bar-label { font-size: 0.8rem; color: rgba(255,255,255,0.7); }
    .chart-legend { display: flex; justify-content: center; gap: 24px; margin-top: 20px; flex-wrap: wrap; }
    .legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; }
    .legend-color { width: 12px; height: 12px; border-radius: 3px; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; z-index: 1000; overflow-y: auto; padding: 20px; }
    .modal-overlay.hidden { display: none; }
    .modal { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 24px; padding: 32px; width: 90%; max-width: 500px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 25px 50px rgba(0,0,0,0.5); max-height: 90vh; overflow-y: auto; }
    .modal.wide { max-width: 700px; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .modal-header h3 { font-size: 1.3rem; font-weight: 700; }
    .modal-close { background: none; border: none; cursor: pointer; color: rgba(255,255,255,0.5); font-size: 1.2rem; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; margin-bottom: 8px; font-size: 0.9rem; color: rgba(255,255,255,0.7); }
    .form-group label .optional { color: rgba(255,255,255,0.4); font-size: 0.8rem; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .input-field { width: 100%; padding: 14px 16px; border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; background: rgba(255,255,255,0.05); color: white; font-size: 1rem; transition: all 0.3s ease; font-family: inherit; }
    .input-field:focus { outline: none; border-color: #e31837; box-shadow: 0 0 20px rgba(227, 24, 55, 0.2); }
    .input-field::placeholder { color: rgba(255,255,255,0.4); }
    textarea.input-field { resize: vertical; min-height: 80px; }
    .service-info-box { padding: 16px; border-radius: 12px; margin-bottom: 16px; }
    .service-info-box p { font-size: 0.85rem; color: rgba(255,255,255,0.7); margin-bottom: 4px; }
    .help-text { color: rgba(255,255,255,0.4); font-size: 0.75rem; margin-top: 4px; }
    .import-dropzone { border: 2px dashed rgba(255,255,255,0.2); border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s ease; }
    .import-dropzone:hover { border-color: #e31837; background: rgba(227, 24, 55, 0.1); }
    .import-dropzone p { color: rgba(255,255,255,0.6); margin-top: 8px; }
    .scrollable { max-height: 600px; overflow-y: auto; padding-right: 8px; }
    .scrollable::-webkit-scrollbar { width: 6px; }
    .scrollable::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 3px; }
    .scrollable::-webkit-scrollbar-thumb { background: rgba(227, 24, 55, 0.5); border-radius: 3px; }
    .hidden { display: none !important; }
    .loading-overlay { position: fixed; inset: 0; background: rgba(15, 15, 26, 0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; }
    .loading-spinner { width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.1); border-top-color: #e31837; border-radius: 50%; animation: spin 1s linear infinite; }
    .loading-text { margin-top: 16px; color: rgba(255,255,255,0.7); font-size: 0.95rem; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .connection-status { display: flex; align-items: center; gap: 8px; padding: 8px 16px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
    .connection-status.online { background: rgba(46, 213, 115, 0.2); color: #2ed573; }
    .connection-status.offline { background: rgba(255, 71, 87, 0.2); color: #ff4757; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; }
    .toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 3000; display: flex; flex-direction: column; gap: 8px; }
    .toast { padding: 16px 24px; border-radius: 12px; font-size: 0.9rem; font-weight: 500; animation: slideIn 0.3s ease; }
    .toast.success { background: rgba(46, 213, 115, 0.9); color: white; }
    .toast.error { background: rgba(255, 71, 87, 0.9); color: white; }
    .toast.info { background: rgba(100, 149, 237, 0.9); color: white; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @media (max-width: 768px) { .header { padding: 16px 20px; } .main { padding: 20px; } .search-filter-bar { flex-direction: column; } .search-box { min-width: 100%; } .form-row { grid-template-columns: 1fr; } .summary-cards { grid-template-columns: repeat(2, 1fr); } .auth-container { padding: 32px 24px; } .user-email { display: none; } }
  </style>
</head>
<body>
  <!-- Auth Page (Login Only) -->
  <div class="auth-page" id="authPage">
    <div class="auth-container">
      <div class="auth-logo">
        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>
      </div>
      <h1 class="auth-title">DIGICONNECT</h1>
      <p class="auth-subtitle">Sign in to manage your subscriptions</p>
      
      <form class="auth-form" id="loginForm" onsubmit="handleLogin(event)">
        <div class="auth-input-group">
          <label>Email</label>
          <input type="email" class="auth-input" id="loginEmail" placeholder="you@example.com" required>
        </div>
        <div class="auth-input-group">
          <label>Password</label>
          <input type="password" class="auth-input" id="loginPassword" placeholder="Enter password" required>
          <button type="button" class="password-toggle" onclick="togglePassword('loginPassword')">üëÅ</button>
        </div>
        <div class="auth-error hidden" id="loginError"></div>
        <button type="submit" class="auth-btn" id="loginBtn">Sign In</button>
      </form>
      
      <p class="auth-footer">üîí Secured Access</p>
    </div>
  </div>

  <!-- Main App -->
  <div class="app-container" id="appContainer">
    <div class="loading-overlay hidden" id="loadingOverlay"><div class="loading-spinner"></div><p class="loading-text">Loading...</p></div>
    <div class="toast-container" id="toastContainer"></div>
    <header class="header">
      <div class="header-content">
        <div class="logo-section">
          <div class="logo-icon"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg></div>
          <div class="logo-text"><h1>DIGICONNECT</h1><p>SUBSCRIPTION MANAGER</p></div>
        </div>
        <div class="user-info">
          <div class="connection-status online" id="connectionStatus"><span class="status-dot"></span><span>Connected</span></div>
          <div class="user-menu-container">
            <button class="user-menu-btn" onclick="toggleUserMenu()">
              <span id="userEmail">user@email.com</span>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
            <div class="user-dropdown" id="userDropdown">
              <button class="user-dropdown-item" onclick="openChangePasswordModal()">üîë Change Password</button>
              <div class="user-dropdown-divider"></div>
              <button class="user-dropdown-item danger" onclick="handleLogout()">üö™ Sign Out</button>
            </div>
          </div>
        </div>
        <nav class="nav">
          <button class="nav-btn active" data-segment="customers" onclick="switchSegment('customers')"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle></svg>Customers</button>
          <button class="nav-btn" data-segment="hosts" onclick="switchSegment('hosts')"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>Host Accounts</button>
          <button class="nav-btn" data-segment="revenue" onclick="switchSegment('revenue')"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline></svg>Revenue</button>
        </nav>
      </div>
    </header>
    <main class="main">
      <div class="service-tabs" id="serviceTabs">
        <button class="service-tab active" data-service="spotify" onclick="switchService('spotify')" style="background:#1DB954;">Spotify</button>
        <button class="service-tab" data-service="netflix" onclick="switchService('netflix')">Netflix</button>
        <button class="service-tab" data-service="appleMusic" onclick="switchService('appleMusic')">Apple Music</button>
        <button class="service-tab" data-service="prime" onclick="switchService('prime')">Amazon Prime</button>
      </div>
      <div class="summary-cards" id="summaryCards"></div>
      <div class="search-filter-bar" id="searchFilterBar">
        <div class="search-box"><svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg><input type="text" class="search-input" id="searchInput" placeholder="Search..." oninput="handleSearch()"></div>
        <select class="filter-select" id="filterHost" onchange="handleFilterChange()"><option value="">All Hosts</option></select>
        <select class="filter-select" id="filterStatus" onchange="handleFilterChange()"><option value="">All Status</option><option value="paid">Paid</option><option value="pending">Pending</option></select>
        <select class="filter-select" id="filterDateRange" onchange="handleFilterChange()"><option value="">All Dates</option><option value="today">Due Today</option><option value="week">This Week</option><option value="month">This Month</option><option value="overdue">Overdue</option></select>
        <select class="filter-select" id="sortBy" onchange="handleFilterChange()"><option value="name">Sort: Name</option><option value="amount">Amount</option><option value="dueDate">Due Date</option></select>
        <button class="clear-filters-btn hidden" id="clearFiltersBtn" onclick="clearFilters()">Clear</button>
      </div>
      <div class="bulk-actions-bar hidden" id="bulkActionsBar">
        <span class="bulk-count"><span id="selectedCount">0</span> selected</span>
        <button class="bulk-btn renew" onclick="bulkRenew()">‚úì Renew All</button>
        <button class="bulk-btn reassign" onclick="openBulkReassign()">üîÑ Reassign</button>
        <button class="bulk-btn delete" onclick="bulkDelete()">üóë Delete All</button>
        <div class="select-all-container"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"><label for="selectAll" style="font-size:0.85rem;cursor:pointer;">Select All</label></div>
      </div>
      <div class="view-toggle" id="viewToggle">
        <button class="view-toggle-btn active" data-view="list" onclick="switchView('list')">üìã List</button>
        <button class="view-toggle-btn" data-view="calendar" onclick="switchView('calendar')">üìÖ Calendar</button>
        <button class="view-toggle-btn" data-view="timeline" onclick="switchView('timeline')">‚è± Timeline</button>
      </div>
      <p class="results-count hidden" id="resultsCount"></p>
      <div class="calendar-view hidden" id="calendarView"><div class="calendar-header"><h3 id="calendarMonth">January 2025</h3><div class="calendar-nav"><button onclick="changeMonth(-1)">‚Üê</button><button onclick="changeMonth(0)">Today</button><button onclick="changeMonth(1)">‚Üí</button></div></div><div class="calendar-grid" id="calendarGrid"></div></div>
      <div class="timeline-view hidden" id="timelineView"><h3 style="margin-bottom:16px;">Upcoming Renewals</h3><div id="timelineContent"></div></div>
      <section id="customersSection"><div class="section-header"><div><h2 id="customersTitle">Spotify Customers</h2><p id="customersSubtitle">0 total</p></div><div class="header-actions"><button class="btn-secondary" onclick="exportData('customers')">üì• Export</button><button class="btn-secondary" onclick="openImportModal()">üì§ Import</button><button class="btn-primary" onclick="openModal('addCustomer')">+ Add Customer</button></div></div><div class="scrollable" id="customersList"></div></section>
      <section id="hostsSection" class="hidden"><div class="section-header"><div><h2 id="hostsTitle">Spotify Host Accounts</h2><p id="hostsSubtitle">0 accounts</p></div><div class="header-actions"><button class="btn-secondary" onclick="exportData('hosts')">üì• Export</button><button class="btn-primary" onclick="openModal('addHost')">+ Add Host</button></div></div><div class="scrollable" id="hostsList"></div></section>
      <section id="revenueSection" class="hidden"><h2 style="margin-bottom:24px;">Revenue Dashboard</h2><div class="period-selector"><button class="period-btn active" data-period="month" onclick="switchPeriod('month')">Month</button><button class="period-btn" data-period="quarter" onclick="switchPeriod('quarter')">Quarter</button><button class="period-btn" data-period="year" onclick="switchPeriod('year')">Year</button><button class="period-btn" data-period="all" onclick="switchPeriod('all')">All</button></div><div class="trend-cards" id="trendCards"></div><div class="stats-grid" id="statsGrid"></div><div class="service-cards" id="serviceCards"></div><div class="chart-section"><div class="chart-header"><h3>Revenue Overview</h3><div style="display:flex;gap:12px;"><button class="btn-secondary" onclick="exportData('revenue')">üì• Export</button><select class="select-field" id="chartType" onchange="renderChart()"><option value="bar">Bar</option><option value="table">Table</option></select></div></div><div class="chart-container" id="chartContainer"></div><div class="chart-legend"><div class="legend-item"><div class="legend-color" style="background:#2ed573;"></div>Revenue</div><div class="legend-item"><div class="legend-color" style="background:#ff4757;"></div>Expenses</div><div class="legend-item"><div class="legend-color" style="background:#ffc107;"></div>Profit</div></div></div></section>
    </main>
  </div>

  <!-- Modals -->
  <div class="modal-overlay hidden" id="changePasswordModal" onclick="closeModal('changePassword')">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header"><h3>üîë Change Password</h3><button class="modal-close" onclick="closeModal('changePassword')">‚úï</button></div>
      <form id="changePasswordForm" onsubmit="handleChangePassword(event)">
        <div class="form-group">
          <label>New Password</label>
          <input type="password" class="input-field" id="newPassword" placeholder="Min 6 characters" minlength="6" required>
        </div>
        <div class="form-group">
          <label>Confirm New Password</label>
          <input type="password" class="input-field" id="confirmNewPassword" placeholder="Confirm password" required>
        </div>
        <div class="auth-error hidden" id="changePasswordError"></div>
        <button type="submit" class="btn-primary" id="changePasswordBtn" style="width:100%;justify-content:center;margin-top:8px;">Update Password</button>
      </form>
    </div>
  </div>

  <div class="modal-overlay hidden" id="addCustomerModal" onclick="closeModal('addCustomer')">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header"><h3>Add New Customer</h3><button class="modal-close" onclick="closeModal('addCustomer')">‚úï</button></div>
      <form id="addCustomerForm" onsubmit="addCustomer(event)">
        <div class="form-group"><label>Customer Name <span class="optional">(optional)</span></label><input type="text" class="input-field" name="name" placeholder="Full name"></div>
        <div class="form-group"><label>Phone Number <span class="optional">(optional)</span></label><input type="tel" class="input-field" name="phone" placeholder="+260 XXX XXX XXX"></div>
        <div class="form-group"><label>Monthly Amount (K)</label><input type="number" class="input-field" name="amount" id="customerAmount"></div>
        <div class="form-row"><div class="form-group"><label>Start Date</label><input type="date" class="input-field" name="startDate" id="customerStartDate"></div><div class="form-group"><label>Duration (Months)</label><input type="number" class="input-field" name="duration" id="customerDuration" value="1" min="1" max="24"></div></div>
        <div class="form-group"><label>Host Account</label><select class="input-field" name="hostAccountId" id="hostSelect"><option value="">Select later</option></select></div>
        <div class="form-group"><label>Payment Status</label><select class="input-field" name="paymentStatus"><option value="pending">Pending</option><option value="paid">Paid</option></select></div>
        <div class="form-group"><label>Notes <span class="optional">(optional)</span></label><textarea class="input-field" name="notes" placeholder="Notes..."></textarea></div>
        <button type="submit" class="btn-primary" style="width:100%;justify-content:center;">+ Add Customer</button>
      </form>
    </div>
  </div>

  <div class="modal-overlay hidden" id="editCustomerModal" onclick="closeModal('editCustomer')">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header"><h3>Edit Customer</h3><button class="modal-close" onclick="closeModal('editCustomer')">‚úï</button></div>
      <form id="editCustomerForm" onsubmit="updateCustomer(event)">
        <input type="hidden" name="id" id="editCustomerId">
        <div class="form-group"><label>Customer Name</label><input type="text" class="input-field" name="name" id="editCustomerName"></div>
        <div class="form-group"><label>Phone Number</label><input type="tel" class="input-field" name="phone" id="editCustomerPhone"></div>
        <div class="form-group"><label>Monthly Amount (K)</label><input type="number" class="input-field" name="amount" id="editCustomerAmount"></div>
        <div class="form-row"><div class="form-group"><label>Start Date</label><input type="date" class="input-field" name="startDate" id="editCustomerStartDate"></div><div class="form-group"><label>Due Date</label><input type="date" class="input-field" name="dueDate" id="editCustomerDueDate"></div></div>
        <div class="form-group"><label>Host Account</label><select class="input-field" name="hostAccountId" id="editHostSelect"><option value="">None</option></select></div>
        <div class="form-group"><label>Payment Status</label><select class="input-field" name="paymentStatus" id="editCustomerPaymentStatus"><option value="pending">Pending</option><option value="paid">Paid</option></select></div>
        <div class="form-group"><label>Notes</label><textarea class="input-field" name="notes" id="editCustomerNotes"></textarea></div>
        <button type="submit" class="btn-primary" style="width:100%;justify-content:center;">Save Changes</button>
      </form>
    </div>
  </div>

  <div class="modal-overlay hidden" id="addHostModal" onclick="closeModal('addHost')">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header"><h3>Add Host Account</h3><button class="modal-close" onclick="closeModal('addHost')">‚úï</button></div>
      <div class="service-info-box" id="hostServiceInfo"></div>
      <form id="addHostForm" onsubmit="addHost(event)">
        <div class="form-group"><label>Account Email <span class="optional">(optional)</span></label><input type="email" class="input-field" name="email" placeholder="account@example.com"></div>
        <div class="form-row"><div class="form-group"><label>Account Cost (K)</label><input type="number" class="input-field" name="cost" id="hostCost"></div><div class="form-group"><label>Max Slots</label><input type="number" class="input-field" name="maxUsers" id="hostMaxUsers" value="5" min="1" max="10"></div></div>
        <div class="form-row"><div class="form-group"><label>Start Date</label><input type="date" class="input-field" name="startDate" id="hostStartDate"></div><div class="form-group"><label>Duration (Months)</label><input type="number" class="input-field" name="duration" id="hostDuration" value="1" min="1" max="24"></div></div>
        <button type="submit" class="btn-primary" style="width:100%;justify-content:center;">+ Add Host Account</button>
      </form>
    </div>
  </div>

  <div class="modal-overlay hidden" id="editHostModal" onclick="closeModal('editHost')">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header"><h3>Edit Host Account</h3><button class="modal-close" onclick="closeModal('editHost')">‚úï</button></div>
      <form id="editHostForm" onsubmit="updateHost(event)">
        <input type="hidden" name="id" id="editHostId">
        <div class="form-group"><label>Account Email</label><input type="email" class="input-field" name="email" id="editHostEmail"></div>
        <div class="form-row"><div class="form-group"><label>Account Cost (K)</label><input type="number" class="input-field" name="cost" id="editHostCost"></div><div class="form-group"><label>Max Slots</label><input type="number" class="input-field" name="maxUsers" id="editHostMaxUsers" min="1" max="10"></div></div>
        <div class="form-row"><div class="form-group"><label>Start Date</label><input type="date" class="input-field" name="startDate" id="editHostStartDate"></div><div class="form-group"><label>Due Date</label><input type="date" class="input-field" name="dueDate" id="editHostDueDate"></div></div>
        <button type="submit" class="btn-primary" style="width:100%;justify-content:center;">Save Changes</button>
      </form>
    </div>
  </div>

  <div class="modal-overlay hidden" id="bulkReassignModal" onclick="closeModal('bulkReassign')">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header"><h3>Reassign Customers</h3><button class="modal-close" onclick="closeModal('bulkReassign')">‚úï</button></div>
      <form id="bulkReassignForm" onsubmit="bulkReassign(event)">
        <div class="form-group"><label>Select New Host</label><select class="input-field" name="hostAccountId" id="bulkReassignSelect" required><option value="">Select host</option></select></div>
        <p style="color:rgba(255,255,255,0.5);font-size:0.85rem;margin-bottom:16px;"><span id="bulkReassignCount">0</span> customers will be reassigned.</p>
        <button type="submit" class="btn-primary" style="width:100%;justify-content:center;">Reassign</button>
      </form>
    </div>
  </div>

  <div class="modal-overlay hidden" id="importModal" onclick="closeModal('import')">
    <div class="modal wide" onclick="event.stopPropagation()">
      <div class="modal-header"><h3>Import Customers</h3><button class="modal-close" onclick="closeModal('import')">‚úï</button></div>
      <div class="import-dropzone" onclick="document.getElementById('importFile').click()">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.4)" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
        <p>Click or drag & drop Excel/CSV file</p>
        <input type="file" id="importFile" accept=".xlsx,.xls,.csv" style="display:none;" onchange="handleImportFile(event)">
      </div>
      <div class="hidden" id="importPreview" style="margin-top:24px;">
        <h4 style="margin-bottom:12px;">Preview (<span id="importCount">0</span> customers)</h4>
        <div style="max-height:200px;overflow:auto;background:rgba(0,0,0,0.2);border-radius:8px;padding:12px;" id="importPreviewContent"></div>
        <div style="margin-top:16px;display:flex;gap:12px;"><button class="btn-secondary" onclick="cancelImport()">Cancel</button><button class="btn-primary" onclick="confirmImport()">Import All</button></div>
      </div>
      <p style="margin-top:20px;font-size:0.8rem;color:rgba(255,255,255,0.4);">Columns: name, phone, amount, startDate, paymentStatus, notes</p>
    </div>
  </div>

  <script>
    // ============================================
    // SUPABASE CONFIGURATION
    // ============================================
    const SUPABASE_URL = 'https://sbklplorrwdslkgtrefg.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNia2xwbG9ycndkc2xrZ3RyZWZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzMjA3MzYsImV4cCI6MjA4Mzg5NjczNn0.gsjgL33ugaEq--lOpdeztGzrKdeHufb_M55rXnm_oXc';
    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;

    // ============================================
    // AUTH FUNCTIONS
    // ============================================
    async function checkAuth() {
      const { data: { session } } = await db.auth.getSession();
      if (session) { currentUser = session.user; showApp(); }
      else { showAuthPage(); }
      db.auth.onAuthStateChange((event, session) => {
        if (event === 'SIGNED_IN' && session) { currentUser = session.user; showApp(); }
        else if (event === 'SIGNED_OUT') { currentUser = null; showAuthPage(); }
      });
    }

    function showAuthPage() {
      document.getElementById('authPage').classList.remove('hidden');
      document.getElementById('appContainer').classList.remove('visible');
    }

    function showApp() {
      document.getElementById('authPage').classList.add('hidden');
      document.getElementById('appContainer').classList.add('visible');
      document.getElementById('userEmail').textContent = currentUser?.email || 'User';
      initializeApp();
    }

    function togglePassword(id) {
      const input = document.getElementById(id);
      input.type = input.type === 'password' ? 'text' : 'password';
    }

    function toggleUserMenu() {
      document.getElementById('userDropdown').classList.toggle('show');
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.user-menu-container')) {
        document.getElementById('userDropdown').classList.remove('show');
      }
    });

    async function handleLogin(e) {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      const btn = document.getElementById('loginBtn');
      const errorEl = document.getElementById('loginError');
      
      btn.disabled = true; btn.textContent = 'Signing in...'; errorEl.classList.add('hidden');
      
      try {
        const { data, error } = await db.auth.signInWithPassword({ email, password });
        if (error) throw error;
      } catch (error) {
        errorEl.textContent = error.message || 'Invalid credentials';
        errorEl.classList.remove('hidden');
      } finally {
        btn.disabled = false; btn.textContent = 'Sign In';
      }
    }

    async function handleLogout() {
      if (!confirm('Sign out?')) return;
      await db.auth.signOut();
    }

    function openChangePasswordModal() {
      document.getElementById('userDropdown').classList.remove('show');
      document.getElementById('changePasswordModal').classList.remove('hidden');
      document.getElementById('newPassword').value = '';
      document.getElementById('confirmNewPassword').value = '';
      document.getElementById('changePasswordError').classList.add('hidden');
    }

    async function handleChangePassword(e) {
      e.preventDefault();
      const newPass = document.getElementById('newPassword').value;
      const confirmPass = document.getElementById('confirmNewPassword').value;
      const errorEl = document.getElementById('changePasswordError');
      const btn = document.getElementById('changePasswordBtn');
      
      errorEl.classList.add('hidden');
      
      if (newPass !== confirmPass) {
        errorEl.textContent = 'Passwords do not match';
        errorEl.classList.remove('hidden');
        return;
      }
      
      btn.disabled = true; btn.textContent = 'Updating...';
      
      try {
        const { error } = await db.auth.updateUser({ password: newPass });
        if (error) throw error;
        closeModal('changePassword');
        showToast('‚úì Password updated!', 'success');
      } catch (error) {
        errorEl.textContent = error.message || 'Failed to update password';
        errorEl.classList.remove('hidden');
      } finally {
        btn.disabled = false; btn.textContent = 'Update Password';
      }
    }

    // ============================================
    // APP STATE & CONFIG
    // ============================================
    const SERVICES = {
      spotify: { name: 'Spotify', price: 60, color: '#1DB954', maxUsers: 5 },
      netflix: { name: 'Netflix', price: 90, color: '#E50914', maxUsers: 5 },
      appleMusic: { name: 'Apple Music', price: 60, color: '#FA243C', maxUsers: 5 },
      prime: { name: 'Amazon Prime', price: 120, color: '#00A8E1', maxUsers: 5 }
    };

    let activeSegment = 'customers', activeService = 'spotify', activeView = 'list', activePeriod = 'month';
    let customers = { spotify: [], netflix: [], appleMusic: [], prime: [] };
    let hostAccounts = { spotify: [], netflix: [], appleMusic: [], prime: [] };
    let selectedCustomers = new Set(), importData = [], calendarDate = new Date();
    let searchQuery = '', filterHost = '', filterStatus = '', filterDateRange = '', sortBy = 'name';
    let appInitialized = false;

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================
    function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
    function formatDate(d) { if (!d) return 'N/A'; return new Date(d).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }); }
    function calculateDueDate(s, m = 1) { if (!s) return null; var d = new Date(s); d.setMonth(d.getMonth() + m); d.setDate(d.getDate() - 3); return d.toISOString().split('T')[0]; }
    function getDaysRemaining(d) { if (!d) return null; return Math.ceil((new Date(d) - new Date()) / 86400000); }
    function isDueSoon(d) { if (!d) return false; var diff = getDaysRemaining(d); return diff <= 5 && diff >= 0; }
    function isOverdue(d) { if (!d) return false; return new Date(d) < new Date(); }
    function getProgressPercentage(s, d) { if (!s || !d) return 0; var start = new Date(s).getTime(), end = new Date(d).getTime(), now = Date.now(); return Math.min(100, Math.max(0, ((now - start) / (end - start)) * 100)); }
    
    function showToast(msg, type = 'info') { var c = document.getElementById('toastContainer'), t = document.createElement('div'); t.className = 'toast ' + type; t.innerHTML = msg; c.appendChild(t); setTimeout(() => t.remove(), 3000); }
    function showLoading(show, msg = 'Loading...') { var o = document.getElementById('loadingOverlay'); o.querySelector('.loading-text').textContent = msg; o.classList.toggle('hidden', !show); }
    function updateConnectionStatus(s) { var el = document.getElementById('connectionStatus'); el.className = 'connection-status ' + s; el.innerHTML = '<span class="status-dot"></span><span>' + (s === 'online' ? 'Connected' : s === 'offline' ? 'Offline' : 'Syncing...') + '</span>'; }
    function copyToClipboard(t) { navigator.clipboard.writeText(t).then(() => showToast('üìã Copied!', 'success')); }
    function openWhatsApp(p, n) { var clean = p.replace(/[^0-9+]/g, ''), msg = encodeURIComponent('Hi ' + (n || 'there') + '! Reminder about your subscription.'); window.open('https://wa.me/' + clean + '?text=' + msg, '_blank'); }

    // ============================================
    // APP INITIALIZATION
    // ============================================
    function initializeApp() {
      if (appInitialized) return;
      appInitialized = true;
      document.getElementById('customerStartDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('hostStartDate').value = new Date().toISOString().split('T')[0];
      loadAllData();
    }

    async function loadAllData() {
      showLoading(true, 'Loading data...');
      try { await loadCustomers(); await loadHostAccounts(); updateConnectionStatus('online'); showLoading(false); render(); }
      catch (e) { console.error(e); updateConnectionStatus('offline'); showLoading(false); showToast('Failed to load data', 'error'); }
    }

    async function loadCustomers() {
      var { data, error } = await db.from('customers').select('*').order('created_at', { ascending: false });
      if (error) throw error;
      for (var k in customers) customers[k] = [];
      if (data) data.forEach(c => { if (customers[c.service_id]) customers[c.service_id].push({ id: c.id, name: c.name, phone: c.phone, amount: c.amount ? parseFloat(c.amount) : null, startDate: c.start_date, dueDate: c.due_date, hostAccountId: c.host_account_id, service: c.service_id, paymentStatus: c.payment_status || 'pending', notes: c.notes }); });
    }

    async function loadHostAccounts() {
      var { data, error } = await db.from('host_accounts').select('*').order('created_at', { ascending: false });
      if (error) throw error;
      for (var k in hostAccounts) hostAccounts[k] = [];
      if (data) data.forEach(h => { if (hostAccounts[h.service_id]) hostAccounts[h.service_id].push({ id: h.id, email: h.email, cost: h.cost ? parseFloat(h.cost) : SERVICES[h.service_id]?.price || 0, maxUsers: h.max_users || 5, startDate: h.start_date, dueDate: h.due_date, service: h.service_id, customers: [] }); });
      for (var sid in customers) customers[sid].forEach(c => { if (c.hostAccountId) { var host = hostAccounts[sid].find(h => h.id === c.hostAccountId); if (host && !host.customers.includes(c.id)) host.customers.push(c.id); }});
    }

    // ============================================
    // DATABASE OPERATIONS
    // ============================================
    async function addCustomerToDB(d) { var { error } = await db.from('customers').insert([{ id: d.id, service_id: d.service, host_account_id: d.hostAccountId, name: d.name, phone: d.phone, amount: d.amount, start_date: d.startDate, due_date: d.dueDate, payment_status: d.paymentStatus, notes: d.notes }]); if (error) throw error; }
    async function addHostToDB(d) { var { error } = await db.from('host_accounts').insert([{ id: d.id, service_id: d.service, email: d.email, cost: d.cost, max_users: d.maxUsers, start_date: d.startDate, due_date: d.dueDate }]); if (error) throw error; }
    async function updateCustomerInDB(d) { var { error } = await db.from('customers').update({ name: d.name, phone: d.phone, amount: d.amount, start_date: d.startDate, due_date: d.dueDate, host_account_id: d.hostAccountId, payment_status: d.paymentStatus, notes: d.notes }).eq('id', d.id); if (error) throw error; }
    async function updateHostInDB(d) { var { error } = await db.from('host_accounts').update({ email: d.email, cost: d.cost, max_users: d.maxUsers, start_date: d.startDate, due_date: d.dueDate }).eq('id', d.id); if (error) throw error; }
    async function deleteCustomerFromDB(id) { var { error } = await db.from('customers').delete().eq('id', id); if (error) throw error; }
    async function deleteHostFromDB(id) { await db.from('customers').update({ host_account_id: null }).eq('host_account_id', id); var { error } = await db.from('host_accounts').delete().eq('id', id); if (error) throw error; }
    async function renewCustomerInDB(id, s, d) { var { error } = await db.from('customers').update({ start_date: s, due_date: d, payment_status: 'pending' }).eq('id', id); if (error) throw error; }
    async function renewHostInDB(id, s, d) { var { error } = await db.from('host_accounts').update({ start_date: s, due_date: d }).eq('id', id); if (error) throw error; }

    async function togglePaymentStatus(id) {
      var c = customers[activeService].find(x => x.id === id); if (!c) return;
      var newStatus = c.paymentStatus === 'paid' ? 'pending' : 'paid';
      try { updateConnectionStatus('syncing'); await db.from('customers').update({ payment_status: newStatus }).eq('id', id); c.paymentStatus = newStatus; updateConnectionStatus('online'); render(); showToast('Status: ' + newStatus, 'success'); }
      catch (e) { updateConnectionStatus('online'); showToast('Failed', 'error'); }
    }

    // ============================================
    // FILTERS & SEARCH
    // ============================================
    function handleSearch() { searchQuery = document.getElementById('searchInput').value.toLowerCase().trim(); updateFiltersVisibility(); render(); }
    function handleFilterChange() { filterHost = document.getElementById('filterHost').value; filterStatus = document.getElementById('filterStatus').value; filterDateRange = document.getElementById('filterDateRange').value; sortBy = document.getElementById('sortBy').value; updateFiltersVisibility(); render(); }
    function clearFilters() { searchQuery = ''; filterHost = ''; filterStatus = ''; filterDateRange = ''; sortBy = 'name'; document.getElementById('searchInput').value = ''; document.getElementById('filterHost').value = ''; document.getElementById('filterStatus').value = ''; document.getElementById('filterDateRange').value = ''; document.getElementById('sortBy').value = 'name'; updateFiltersVisibility(); render(); }
    function updateFiltersVisibility() { document.getElementById('clearFiltersBtn').classList.toggle('hidden', !(searchQuery || filterHost || filterStatus || filterDateRange)); }

    function filterCustomers(list) {
      var filtered = list.filter(c => {
        if (searchQuery && !(c.name && c.name.toLowerCase().includes(searchQuery)) && !(c.phone && c.phone.toLowerCase().includes(searchQuery))) return false;
        if (filterHost && c.hostAccountId !== filterHost) return false;
        if (filterStatus && c.paymentStatus !== filterStatus) return false;
        if (filterDateRange) {
          var today = new Date(); today.setHours(0,0,0,0); var due = c.dueDate ? new Date(c.dueDate) : null;
          if (filterDateRange === 'today' && (!due || due.toDateString() !== today.toDateString())) return false;
          if (filterDateRange === 'week') { var wk = new Date(today); wk.setDate(wk.getDate() + 7); if (!due || due < today || due > wk) return false; }
          if (filterDateRange === 'month') { var mo = new Date(today); mo.setMonth(mo.getMonth() + 1); if (!due || due < today || due > mo) return false; }
          if (filterDateRange === 'overdue' && (!due || due >= today)) return false;
        }
        return true;
      });
      filtered.sort((a, b) => { if (sortBy === 'name') return (a.name || '').localeCompare(b.name || ''); if (sortBy === 'amount') return (b.amount || 0) - (a.amount || 0); if (sortBy === 'dueDate') { if (!a.dueDate) return 1; if (!b.dueDate) return -1; return new Date(a.dueDate) - new Date(b.dueDate); } return 0; });
      return filtered;
    }

    function filterHosts(list) { return list.filter(h => { if (searchQuery && !(h.email && h.email.toLowerCase().includes(searchQuery))) return false; return true; }); }

    // ============================================
    // BULK OPERATIONS
    // ============================================
    function toggleCustomerSelection(id) { if (selectedCustomers.has(id)) selectedCustomers.delete(id); else selectedCustomers.add(id); updateBulkActionsBar(); render(); }
    function toggleSelectAll() { var all = filterCustomers(customers[activeService] || []); if (selectedCustomers.size === all.length) selectedCustomers.clear(); else all.forEach(c => selectedCustomers.add(c.id)); document.getElementById('selectAll').checked = selectedCustomers.size === all.length; updateBulkActionsBar(); render(); }
    function updateBulkActionsBar() { document.getElementById('selectedCount').textContent = selectedCustomers.size; document.getElementById('bulkActionsBar').classList.toggle('hidden', selectedCustomers.size === 0); }

    async function bulkRenew() {
      if (selectedCustomers.size === 0 || !confirm('Renew ' + selectedCustomers.size + ' customers?')) return;
      try { showLoading(true, 'Renewing...'); var s = new Date().toISOString().split('T')[0], d = calculateDueDate(new Date(), 1);
        for (var id of selectedCustomers) { await renewCustomerInDB(id, s, d); var i = customers[activeService].findIndex(c => c.id === id); if (i !== -1) { customers[activeService][i].startDate = s; customers[activeService][i].dueDate = d; customers[activeService][i].paymentStatus = 'pending'; }}
        selectedCustomers.clear(); updateBulkActionsBar(); render(); showLoading(false); showToast('‚úì Renewed!', 'success');
      } catch (e) { showLoading(false); showToast('Failed', 'error'); }
    }

    async function bulkDelete() {
      if (selectedCustomers.size === 0 || !confirm('Delete ' + selectedCustomers.size + ' customers?')) return;
      try { showLoading(true, 'Deleting...');
        for (var id of selectedCustomers) { await deleteCustomerFromDB(id); var c = customers[activeService].find(x => x.id === id); if (c && c.hostAccountId) { var h = hostAccounts[activeService].find(x => x.id === c.hostAccountId); if (h) h.customers = h.customers.filter(x => x !== id); } customers[activeService] = customers[activeService].filter(x => x.id !== id); }
        selectedCustomers.clear(); updateBulkActionsBar(); render(); showLoading(false); showToast('‚úì Deleted!', 'success');
      } catch (e) { showLoading(false); showToast('Failed', 'error'); }
    }

    function openBulkReassign() {
      if (selectedCustomers.size === 0) return;
      var sel = document.getElementById('bulkReassignSelect'), hosts = hostAccounts[activeService] || [];
      sel.innerHTML = '<option value="">Select host</option>' + hosts.map(h => '<option value="' + h.id + '"' + (h.maxUsers - h.customers.length <= 0 ? ' disabled' : '') + '>' + (h.email || 'Host #' + h.id.slice(-4)) + ' (' + (h.maxUsers - h.customers.length) + ' slots)</option>').join('');
      document.getElementById('bulkReassignCount').textContent = selectedCustomers.size;
      document.getElementById('bulkReassignModal').classList.remove('hidden');
    }

    async function bulkReassign(e) {
      e.preventDefault(); var newHostId = document.getElementById('bulkReassignSelect').value; if (!newHostId) return;
      try { showLoading(true, 'Reassigning...');
        for (var id of selectedCustomers) { var c = customers[activeService].find(x => x.id === id); if (!c) continue; var oldHostId = c.hostAccountId;
          await db.from('customers').update({ host_account_id: newHostId }).eq('id', id);
          if (oldHostId) { var oh = hostAccounts[activeService].find(x => x.id === oldHostId); if (oh) oh.customers = oh.customers.filter(x => x !== id); }
          var nh = hostAccounts[activeService].find(x => x.id === newHostId); if (nh && !nh.customers.includes(id)) nh.customers.push(id); c.hostAccountId = newHostId;
        }
        selectedCustomers.clear(); updateBulkActionsBar(); closeModal('bulkReassign'); render(); showLoading(false); showToast('‚úì Reassigned!', 'success');
      } catch (e) { showLoading(false); showToast('Failed', 'error'); }
    }

    // ============================================
    // EXPORT & IMPORT
    // ============================================
    function exportData(type) {
      var data = [], filename = '';
      if (type === 'customers') { var list = customers[activeService] || []; data = list.map(c => { var h = hostAccounts[activeService].find(x => x.id === c.hostAccountId); return { Name: c.name || '', Phone: c.phone || '', Amount: c.amount || 0, 'Start Date': c.startDate || '', 'Due Date': c.dueDate || '', 'Payment Status': c.paymentStatus || 'pending', 'Host Account': h?.email || '', Notes: c.notes || '' }; }); filename = SERVICES[activeService].name + '_Customers_' + new Date().toISOString().split('T')[0] + '.xlsx'; }
      else if (type === 'hosts') { var list = hostAccounts[activeService] || []; data = list.map(h => ({ Email: h.email || '', Cost: h.cost || 0, 'Max Users': h.maxUsers || 5, 'Used Slots': h.customers.length, 'Available': h.maxUsers - h.customers.length, 'Start Date': h.startDate || '', 'Due Date': h.dueDate || '' })); filename = SERVICES[activeService].name + '_Hosts_' + new Date().toISOString().split('T')[0] + '.xlsx'; }
      else if (type === 'revenue') { for (var k in SERVICES) { var svc = SERVICES[k], rev = 0, exp = 0; (customers[k] || []).forEach(c => { rev += parseFloat(c.amount) || 0; }); (hostAccounts[k] || []).forEach(h => { exp += h.cost || svc.price || 0; }); data.push({ Service: svc.name, Customers: (customers[k] || []).length, Hosts: (hostAccounts[k] || []).length, Revenue: rev, Expenses: exp, Profit: rev - exp }); } filename = 'Revenue_Report_' + new Date().toISOString().split('T')[0] + '.xlsx'; }
      var ws = XLSX.utils.json_to_sheet(data), wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Data'); XLSX.writeFile(wb, filename); showToast('üì• Exported!', 'success');
    }

    function openImportModal() { document.getElementById('importModal').classList.remove('hidden'); document.getElementById('importPreview').classList.add('hidden'); document.getElementById('importFile').value = ''; importData = []; }
    function handleImportFile(e) { var file = e.target.files[0]; if (!file) return; var reader = new FileReader(); reader.onload = function(ev) { try { var data = new Uint8Array(ev.target.result), wb = XLSX.read(data, { type: 'array' }), json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); importData = json.map(r => ({ name: r.name || r.Name || null, phone: r.phone || r.Phone || null, amount: parseFloat(r.amount || r.Amount) || null, startDate: r.startDate || r['Start Date'] || null, paymentStatus: (r.paymentStatus || r['Payment Status'] || 'pending').toLowerCase(), notes: r.notes || r.Notes || null })); document.getElementById('importCount').textContent = importData.length; document.getElementById('importPreviewContent').innerHTML = importData.slice(0, 5).map(c => '<div style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.1);"><strong>' + (c.name || 'Unnamed') + '</strong> - ' + (c.phone || 'No phone') + ' - K' + (c.amount || 0) + '</div>').join('') + (importData.length > 5 ? '<div style="padding:8px;color:rgba(255,255,255,0.5);">...and ' + (importData.length - 5) + ' more</div>' : ''); document.getElementById('importPreview').classList.remove('hidden'); } catch (err) { showToast('Failed to read file', 'error'); } }; reader.readAsArrayBuffer(file); }
    function cancelImport() { document.getElementById('importPreview').classList.add('hidden'); document.getElementById('importFile').value = ''; importData = []; }
    async function confirmImport() { if (importData.length === 0) return; try { showLoading(true, 'Importing...'); for (var c of importData) { var s = c.startDate || new Date().toISOString().split('T')[0], nc = { id: generateId(), name: c.name, phone: c.phone, amount: c.amount, startDate: s, dueDate: calculateDueDate(s, 1), hostAccountId: null, service: activeService, paymentStatus: c.paymentStatus, notes: c.notes }; await addCustomerToDB(nc); customers[activeService].push(nc); } closeModal('import'); render(); showLoading(false); showToast('‚úì Imported ' + importData.length + '!', 'success'); importData = []; } catch (e) { showLoading(false); showToast('Failed', 'error'); } }

    // ============================================
    // VIEW SWITCHING
    // ============================================
    function switchView(v) { activeView = v; document.querySelectorAll('.view-toggle-btn').forEach(b => b.classList.toggle('active', b.dataset.view === v)); document.getElementById('calendarView').classList.toggle('hidden', v !== 'calendar'); document.getElementById('timelineView').classList.toggle('hidden', v !== 'timeline'); document.getElementById('customersList').classList.toggle('hidden', v !== 'list' && activeSegment === 'customers'); render(); }
    function switchPeriod(p) { activePeriod = p; document.querySelectorAll('.period-btn').forEach(b => b.classList.toggle('active', b.dataset.period === p)); renderRevenue(); }
    function changeMonth(d) { if (d === 0) calendarDate = new Date(); else calendarDate.setMonth(calendarDate.getMonth() + d); renderCalendar(); }

    function renderCalendar() {
      var y = calendarDate.getFullYear(), m = calendarDate.getMonth();
      document.getElementById('calendarMonth').textContent = calendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
      var first = new Date(y, m, 1), last = new Date(y, m + 1, 0), pad = first.getDay(), all = customers[activeService] || [], dueByDate = {};
      all.forEach(c => { if (c.dueDate) { if (!dueByDate[c.dueDate]) dueByDate[c.dueDate] = []; dueByDate[c.dueDate].push(c); }});
      var today = new Date().toISOString().split('T')[0], html = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(d => '<div class="calendar-day-header">' + d + '</div>').join('');
      var prev = new Date(y, m, 0); for (var i = pad - 1; i >= 0; i--) html += '<div class="calendar-day other-month">' + (prev.getDate() - i) + '</div>';
      for (var day = 1; day <= last.getDate(); day++) { var ds = y + '-' + String(m + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0'), isToday = ds === today, items = dueByDate[ds] || [], hasOver = items.some(c => isOverdue(c.dueDate)), cls = 'calendar-day' + (isToday ? ' today' : '') + (items.length > 0 ? (hasOver ? ' has-overdue' : ' has-due') : ''); html += '<div class="' + cls + '" onclick="showDayDetails(\'' + ds + '\')">' + day + (items.length > 0 ? '<span class="calendar-day-count">' + items.length + '</span>' : '') + '</div>'; }
      var total = pad + last.getDate(), rem = 7 - (total % 7); if (rem < 7) for (var i = 1; i <= rem; i++) html += '<div class="calendar-day other-month">' + i + '</div>';
      document.getElementById('calendarGrid').innerHTML = html;
    }

    function showDayDetails(ds) { var all = customers[activeService] || [], due = all.filter(c => c.dueDate === ds); if (due.length === 0) { showToast('No customers due', 'info'); return; } showToast('Due: ' + due.map(c => c.name || 'Unnamed').join(', '), 'info'); }

    function renderTimeline() {
      var all = customers[activeService] || [], upcoming = all.filter(c => c.dueDate).sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate)).slice(0, 20);
      if (upcoming.length === 0) { document.getElementById('timelineContent').innerHTML = '<p style="color:rgba(255,255,255,0.5);text-align:center;padding:40px;">No upcoming renewals</p>'; return; }
      var grouped = {}; upcoming.forEach(c => { if (!grouped[c.dueDate]) grouped[c.dueDate] = []; grouped[c.dueDate].push(c); });
      var html = ''; for (var [date, items] of Object.entries(grouped)) { var d = new Date(date), over = isOverdue(date); html += '<div class="timeline-item"><div class="timeline-date"><div class="timeline-date-day" style="color:' + (over ? '#ff4757' : '#fff') + ';">' + d.getDate() + '</div><div class="timeline-date-month">' + d.toLocaleDateString('en-US', { month: 'short' }) + '</div></div><div class="timeline-content"><div class="timeline-items">' + items.map(c => '<div class="timeline-chip ' + (over ? 'danger' : 'warning') + '">üë§ ' + (c.name || 'Unnamed') + '</div>').join('') + '</div></div></div>'; }
      document.getElementById('timelineContent').innerHTML = html;
    }

    function switchSegment(s) { activeSegment = s; selectedCustomers.clear(); updateBulkActionsBar(); document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('active', b.dataset.segment === s)); document.getElementById('serviceTabs').classList.toggle('hidden', s === 'revenue'); document.getElementById('searchFilterBar').classList.toggle('hidden', s === 'revenue'); document.getElementById('summaryCards').classList.toggle('hidden', s === 'revenue'); document.getElementById('viewToggle').classList.toggle('hidden', s === 'revenue'); document.getElementById('bulkActionsBar').classList.toggle('hidden', s !== 'customers' || selectedCustomers.size === 0); document.getElementById('customersSection').classList.toggle('hidden', s !== 'customers'); document.getElementById('hostsSection').classList.toggle('hidden', s !== 'hosts'); document.getElementById('revenueSection').classList.toggle('hidden', s !== 'revenue'); document.getElementById('calendarView').classList.toggle('hidden', activeView !== 'calendar' || s === 'revenue'); document.getElementById('timelineView').classList.toggle('hidden', activeView !== 'timeline' || s === 'revenue'); document.getElementById('resultsCount').classList.add('hidden'); render(); }
    function switchService(s) { activeService = s; selectedCustomers.clear(); updateBulkActionsBar(); document.querySelectorAll('.service-tab').forEach(b => { var a = b.dataset.service === s; b.classList.toggle('active', a); b.style.background = a ? SERVICES[s].color : ''; }); updateHostFilterSelect(); render(); }
    function updateHostFilterSelect() { var hosts = hostAccounts[activeService] || [], sel = document.getElementById('filterHost'); sel.innerHTML = '<option value="">All Hosts</option>' + hosts.map(h => '<option value="' + h.id + '">' + (h.email || 'Host #' + h.id.slice(-4)) + '</option>').join(''); }
    function render() { renderSummaryCards(); if (activeSegment === 'customers') { renderCustomers(); if (activeView === 'calendar') renderCalendar(); if (activeView === 'timeline') renderTimeline(); } else if (activeSegment === 'hosts') renderHosts(); else renderRevenue(); }

    // ============================================
    // RENDER FUNCTIONS
    // ============================================
    function renderSummaryCards() {
      var all = customers[activeService] || [], overdue = all.filter(c => isOverdue(c.dueDate)).length, dueSoon = all.filter(c => isDueSoon(c.dueDate)).length, pending = all.filter(c => c.paymentStatus === 'pending').length, paid = all.filter(c => c.paymentStatus === 'paid').length;
      document.getElementById('summaryCards').innerHTML = '<div class="summary-card danger"><div class="summary-card-value" style="color:#ff4757;">' + overdue + '</div><div class="summary-card-label">Overdue</div></div><div class="summary-card warning"><div class="summary-card-value" style="color:#ffc107;">' + dueSoon + '</div><div class="summary-card-label">Due Soon</div></div><div class="summary-card info"><div class="summary-card-value" style="color:#ffc107;">' + pending + '</div><div class="summary-card-label">Pending</div></div><div class="summary-card success"><div class="summary-card-value" style="color:#2ed573;">' + paid + '</div><div class="summary-card-label">Paid</div></div>';
    }

    function renderCustomers() {
      var svc = SERVICES[activeService], all = customers[activeService] || [], list = filterCustomers(all);
      document.getElementById('customersTitle').textContent = svc.name + ' Customers';
      document.getElementById('customersSubtitle').textContent = all.length + ' total ‚Ä¢ K' + svc.price + '/month';
      document.getElementById('customerAmount').value = svc.price;
      updateHostFilterSelect();
      var hasFilters = searchQuery || filterHost || filterStatus || filterDateRange, resultsEl = document.getElementById('resultsCount');
      if (hasFilters) { resultsEl.classList.remove('hidden'); resultsEl.textContent = 'Showing ' + list.length + ' of ' + all.length; } else resultsEl.classList.add('hidden');
      if (activeView !== 'list') return;
      var c = document.getElementById('customersList');
      if (list.length === 0) { c.innerHTML = '<div class="card card-empty"><p>' + (hasFilters ? 'No matches.' : 'No customers yet.') + '</p></div>'; return; }
      c.innerHTML = list.map(cust => {
        var host = hostAccounts[activeService].find(h => h.customers.includes(cust.id)), over = isOverdue(cust.dueDate), soon = isDueSoon(cust.dueDate), days = getDaysRemaining(cust.dueDate), prog = getProgressPercentage(cust.startDate, cust.dueDate), isSel = selectedCustomers.has(cust.id);
        var statusClass = cust.dueDate ? (over ? 'status-danger' : soon ? 'status-warning' : 'status-success') : 'status-default';
        var daysClass = days !== null ? (days < 0 ? 'danger' : days <= 5 ? 'warning' : 'success') : 'success';
        var progColor = over ? '#ff4757' : soon ? '#ffc107' : '#2ed573', circ = 2 * Math.PI * 18, dash = circ - (prog / 100) * circ;
        return '<div class="card ' + statusClass + (isSel ? ' selected' : '') + '"><input type="checkbox" class="card-checkbox" ' + (isSel ? 'checked' : '') + ' onchange="toggleCustomerSelection(\'' + cust.id + '\')"><div class="customer-card"><div class="customer-info"><div class="progress-ring-container"><svg class="progress-ring" width="50" height="50"><circle class="progress-ring-bg" cx="25" cy="25" r="18"/><circle class="progress-ring-fill" cx="25" cy="25" r="18" stroke="' + progColor + '" stroke-dasharray="' + circ + '" stroke-dashoffset="' + dash + '"/></svg><span class="progress-ring-text" style="color:' + progColor + ';">' + Math.round(prog) + '%</span></div><div class="customer-details"><h3>' + (cust.name || '<span class="not-available">No name</span>') + '</h3><div class="customer-meta"><span>' + (cust.phone ? 'üìû ' + cust.phone : '<span class="not-available">üìû N/A</span>') + '</span><span>' + (cust.amount !== null ? 'üí∞ K' + cust.amount : '<span class="not-available">üí∞ N/A</span>') + '</span><span class="payment-status ' + cust.paymentStatus + '" onclick="togglePaymentStatus(\'' + cust.id + '\')">' + (cust.paymentStatus === 'paid' ? '‚úì Paid' : '‚è≥ Pending') + '</span>' + (cust.phone ? '<span class="quick-actions"><button class="btn-icon" onclick="copyToClipboard(\'' + cust.phone + '\')" title="Copy">üìã</button><button class="btn-icon whatsapp" onclick="openWhatsApp(\'' + cust.phone + '\',\'' + (cust.name || '') + '\')" title="WhatsApp">üì±</button></span>' : '') + '</div><div class="badges"><span class="badge badge-default">' + (cust.startDate ? formatDate(cust.startDate) : 'No date') + '</span>' + (days !== null ? '<span class="days-remaining ' + daysClass + '">' + (days < 0 ? '‚ö†Ô∏è ' + Math.abs(days) + 'd overdue' : days === 0 ? '‚ö†Ô∏è Due today' : '‚è± ' + days + 'd left') + '</span>' : '') + (host ? '<span class="badge badge-info">üè† ' + (host.email || 'Host') + '</span>' : '') + '</div>' + (cust.notes ? '<div class="customer-notes">' + cust.notes + '</div>' : '') + '</div></div><div class="card-actions"><button class="btn-edit" onclick="openEditCustomer(\'' + cust.id + '\')">‚úèÔ∏è</button>' + ((over || soon) ? '<button class="btn-success" onclick="renewCustomer(\'' + cust.id + '\')">‚úì</button>' : '') + '<button class="btn-danger" onclick="deleteCustomer(\'' + cust.id + '\')">üóë</button></div></div></div>';
      }).join('');
    }

    function renderHosts() {
      var svc = SERVICES[activeService], all = hostAccounts[activeService] || [], list = filterHosts(all);
      document.getElementById('hostsTitle').textContent = svc.name + ' Host Accounts';
      document.getElementById('hostsSubtitle').textContent = all.length + ' accounts';
      if (activeView !== 'list') return;
      var c = document.getElementById('hostsList');
      if (list.length === 0) { c.innerHTML = '<div class="card card-empty"><p>No hosts yet.</p></div>'; return; }
      c.innerHTML = list.map(h => {
        var over = isOverdue(h.dueDate), soon = isDueSoon(h.dueDate), days = getDaysRemaining(h.dueDate), avail = h.maxUsers - h.customers.length, usagePct = (h.customers.length / h.maxUsers) * 100, custs = (customers[activeService] || []).filter(c => h.customers.includes(c.id));
        var statusClass = h.dueDate ? (over ? 'status-danger' : soon ? 'status-warning' : 'status-success') : 'status-default';
        var daysClass = days !== null ? (days < 0 ? 'danger' : days <= 5 ? 'warning' : 'success') : 'success';
        var slotColor = avail > 2 ? '#2ed573' : avail > 0 ? '#ffc107' : '#ff4757';
        return '<div class="card ' + statusClass + '"><div class="customer-card"><div style="flex:1;"><div class="customer-info" style="margin-bottom:12px;"><div class="customer-avatar" style="background:' + svc.color + '20;"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="' + svc.color + '" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg></div><div><h3>' + (h.email || '<span class="not-available">No email</span>') + '</h3><p style="color:rgba(255,255,255,0.5);font-size:0.85rem;">K' + (h.cost || svc.price) + '/month</p></div></div><div class="slot-progress"><div class="slot-progress-label"><span>Slots</span><span style="color:' + slotColor + ';">' + h.customers.length + '/' + h.maxUsers + '</span></div><div class="slot-progress-bar"><div class="slot-progress-fill" style="width:' + usagePct + '%;background:' + slotColor + ';"></div></div></div><div class="badges" style="margin-top:12px;"><span class="badge badge-default">' + (h.startDate ? formatDate(h.startDate) : 'No date') + '</span>' + (days !== null ? '<span class="days-remaining ' + daysClass + '">' + (days < 0 ? '‚ö†Ô∏è ' + Math.abs(days) + 'd overdue' : days === 0 ? '‚ö†Ô∏è Due today' : '‚è± ' + days + 'd left') + '</span>' : '') + '</div>' + (custs.length > 0 ? '<div class="host-customers"><p>Customers:</p><div class="host-customer-tags">' + custs.map(c => '<span class="host-customer-tag">üë§ ' + (c.name || 'Unnamed') + '</span>').join('') + '</div></div>' : '') + '</div><div class="card-actions"><button class="btn-edit" onclick="openEditHost(\'' + h.id + '\')">‚úèÔ∏è</button>' + ((over || soon) ? '<button class="btn-success" onclick="renewHost(\'' + h.id + '\')">‚úì</button>' : '') + '<button class="btn-danger" onclick="deleteHost(\'' + h.id + '\')">üóë</button></div></div></div>';
      }).join('');
    }

    function renderRevenue() {
      var totExp = 0, totRev = 0, totCust = 0, totHost = 0;
      for (var k in hostAccounts) { hostAccounts[k].forEach(h => { totExp += h.cost || SERVICES[k]?.price || 0; totHost++; }); }
      for (var k in customers) { customers[k].forEach(c => { totRev += parseFloat(c.amount) || 0; totCust++; }); }
      var net = totRev - totExp, margin = totExp > 0 ? ((totRev / totExp) * 100 - 100).toFixed(1) : 0;
      var trends = [{ label: 'Revenue', value: 'K' + totRev, color: '#2ed573' }, { label: 'Expenses', value: 'K' + totExp, color: '#ff4757' }, { label: 'Profit', value: 'K' + net, color: net >= 0 ? '#2ed573' : '#ff4757' }, { label: 'Customers', value: totCust, color: '#6495ed' }];
      document.getElementById('trendCards').innerHTML = trends.map(t => '<div class="trend-card"><div class="trend-card-title">' + t.label + '</div><div class="trend-card-value" style="color:' + t.color + ';">' + t.value + '</div></div>').join('');
      document.getElementById('statsGrid').innerHTML = '<div class="stat-card" style="border-left:4px solid #ff4757;"><p>Total Expenses</p><div class="stat-value" style="color:#ff4757;">K' + totExp + '</div><div class="stat-sub">' + totHost + ' hosts</div></div><div class="stat-card" style="border-left:4px solid #2ed573;"><p>Total Revenue</p><div class="stat-value" style="color:#2ed573;">K' + totRev + '</div><div class="stat-sub">' + totCust + ' customers</div></div><div class="stat-card" style="border-left:4px solid ' + (net >= 0 ? '#2ed573' : '#ff4757') + ';"><p>Net Profit</p><div class="stat-value" style="color:' + (net >= 0 ? '#2ed573' : '#ff4757') + ';">K' + net + '</div><div class="stat-sub">' + margin + '% margin</div></div>';
      var html = ''; for (var key in SERVICES) { var svc = SERVICES[key], sRev = 0, sExp = 0; (customers[key] || []).forEach(c => { sRev += parseFloat(c.amount) || 0; }); (hostAccounts[key] || []).forEach(h => { sExp += h.cost || svc.price || 0; }); var sProf = sRev - sExp; html += '<div class="service-card" style="border-top:3px solid ' + svc.color + ';"><div class="service-card-header"><div style="width:16px;height:16px;border-radius:50%;background:' + svc.color + ';"></div><span>' + svc.name + '</span></div><div class="service-card-row"><span>Customers</span><span>' + (customers[key] || []).length + '</span></div><div class="service-card-row"><span>Revenue</span><span style="color:#2ed573;">K' + sRev + '</span></div><div class="service-card-row"><span>Expenses</span><span style="color:#ff4757;">K' + sExp + '</span></div><div class="service-card-row service-card-divider"><span>Profit</span><span style="color:' + (sProf >= 0 ? '#2ed573' : '#ff4757') + ';">K' + sProf + '</span></div></div>'; }
      document.getElementById('serviceCards').innerHTML = html;
      renderChart();
    }

    function renderChart() {
      var type = document.getElementById('chartType').value, c = document.getElementById('chartContainer'), data = [];
      for (var key in SERVICES) { var svc = SERVICES[key], rev = 0, exp = 0; (customers[key] || []).forEach(c => { rev += parseFloat(c.amount) || 0; }); (hostAccounts[key] || []).forEach(h => { exp += h.cost || svc.price || 0; }); data.push({ name: svc.name, color: svc.color, revenue: rev, expenses: exp, profit: rev - exp }); }
      var max = Math.max.apply(null, data.map(d => Math.max(d.revenue, d.expenses, Math.abs(d.profit)))) || 1;
      if (type === 'bar') c.innerHTML = data.map(d => '<div class="chart-bar-group"><div class="chart-bars"><div class="chart-bar" style="height:' + (d.revenue / max * 200) + 'px;background:#2ed573;"></div><div class="chart-bar" style="height:' + (d.expenses / max * 200) + 'px;background:#ff4757;"></div><div class="chart-bar" style="height:' + (Math.abs(d.profit) / max * 200) + 'px;background:#ffc107;"></div></div><div class="chart-bar-label">' + d.name + '</div></div>').join('');
      else c.innerHTML = '<table style="width:100%;border-collapse:collapse;"><tr style="border-bottom:1px solid rgba(255,255,255,0.1);"><th style="text-align:left;padding:12px;">Service</th><th style="text-align:right;padding:12px;">Revenue</th><th style="text-align:right;padding:12px;">Expenses</th><th style="text-align:right;padding:12px;">Profit</th></tr>' + data.map(d => '<tr style="border-bottom:1px solid rgba(255,255,255,0.05);"><td style="padding:12px;">' + d.name + '</td><td style="text-align:right;padding:12px;color:#2ed573;">K' + d.revenue + '</td><td style="text-align:right;padding:12px;color:#ff4757;">K' + d.expenses + '</td><td style="text-align:right;padding:12px;color:' + (d.profit >= 0 ? '#2ed573' : '#ff4757') + ';">K' + d.profit + '</td></tr>').join('') + '</table>';
    }

    // ============================================
    // MODAL FUNCTIONS
    // ============================================
    function openModal(t) {
      if (t === 'addCustomer') { document.getElementById('addCustomerModal').classList.remove('hidden'); updateHostSelectDropdown('hostSelect'); document.getElementById('customerDuration').value = 1; }
      else if (t === 'addHost') { document.getElementById('addHostModal').classList.remove('hidden'); var svc = SERVICES[activeService]; document.getElementById('hostServiceInfo').innerHTML = '<p>Service: <strong style="color:' + svc.color + ';">' + svc.name + '</strong></p><p>Default: K' + svc.price + '/month, 5 slots</p>'; document.getElementById('hostServiceInfo').style.background = svc.color + '20'; document.getElementById('hostCost').value = svc.price; document.getElementById('hostMaxUsers').value = 5; document.getElementById('hostDuration').value = 1; }
    }
    function closeModal(t) { var map = { addCustomer: 'addCustomerModal', addHost: 'addHostModal', editCustomer: 'editCustomerModal', editHost: 'editHostModal', bulkReassign: 'bulkReassignModal', import: 'importModal', changePassword: 'changePasswordModal' }; if (map[t]) document.getElementById(map[t]).classList.add('hidden'); if (t === 'addCustomer') { document.getElementById('addCustomerForm').reset(); document.getElementById('customerStartDate').value = new Date().toISOString().split('T')[0]; } else if (t === 'addHost') { document.getElementById('addHostForm').reset(); document.getElementById('hostStartDate').value = new Date().toISOString().split('T')[0]; } }
    function updateHostSelectDropdown(selId) { var hosts = hostAccounts[activeService] || [], sel = document.getElementById(selId); sel.innerHTML = '<option value="">None</option>' + hosts.map(h => { var avail = h.maxUsers - h.customers.length; return '<option value="' + h.id + '"' + (avail <= 0 ? ' disabled' : '') + '>' + (h.email || 'Host #' + h.id.slice(-4)) + ' (' + avail + ' slots)</option>'; }).join(''); document.getElementById('customerAmount').value = SERVICES[activeService].price; }
    function openEditCustomer(id) { var c = customers[activeService].find(x => x.id === id); if (!c) return; document.getElementById('editCustomerId').value = c.id; document.getElementById('editCustomerName').value = c.name || ''; document.getElementById('editCustomerPhone').value = c.phone || ''; document.getElementById('editCustomerAmount').value = c.amount || ''; document.getElementById('editCustomerStartDate').value = c.startDate || ''; document.getElementById('editCustomerDueDate').value = c.dueDate || ''; document.getElementById('editCustomerPaymentStatus').value = c.paymentStatus || 'pending'; document.getElementById('editCustomerNotes').value = c.notes || ''; updateHostSelectDropdown('editHostSelect'); document.getElementById('editHostSelect').value = c.hostAccountId || ''; document.getElementById('editCustomerModal').classList.remove('hidden'); }
    function openEditHost(id) { var h = hostAccounts[activeService].find(x => x.id === id); if (!h) return; document.getElementById('editHostId').value = h.id; document.getElementById('editHostEmail').value = h.email || ''; document.getElementById('editHostCost').value = h.cost || ''; document.getElementById('editHostMaxUsers').value = h.maxUsers || 5; document.getElementById('editHostStartDate').value = h.startDate || ''; document.getElementById('editHostDueDate').value = h.dueDate || ''; document.getElementById('editHostModal').classList.remove('hidden'); }

    // ============================================
    // CRUD OPERATIONS
    // ============================================
    async function addCustomer(e) { e.preventDefault(); var f = new FormData(e.target), s = f.get('startDate') || null, dur = parseInt(f.get('duration')) || 1, d = s ? calculateDueDate(s, dur) : null; var nc = { id: generateId(), name: f.get('name') || null, phone: f.get('phone') || null, amount: f.get('amount') ? parseFloat(f.get('amount')) : null, startDate: s, dueDate: d, hostAccountId: f.get('hostAccountId') || null, service: activeService, paymentStatus: f.get('paymentStatus') || 'pending', notes: f.get('notes') || null }; try { showLoading(true, 'Adding...'); await addCustomerToDB(nc); customers[activeService].push(nc); if (nc.hostAccountId) { var hi = hostAccounts[activeService].findIndex(h => h.id === nc.hostAccountId); if (hi !== -1) hostAccounts[activeService][hi].customers.push(nc.id); } closeModal('addCustomer'); render(); showLoading(false); showToast('‚úì Added!', 'success'); } catch (err) { showLoading(false); showToast('Failed: ' + err.message, 'error'); } }
    
    async function updateCustomer(e) { e.preventDefault(); var f = new FormData(e.target), id = f.get('id'), old = customers[activeService].find(c => c.id === id); if (!old) return; var newHostId = f.get('hostAccountId') || null, oldHostId = old.hostAccountId; var upd = { id: id, name: f.get('name') || null, phone: f.get('phone') || null, amount: f.get('amount') ? parseFloat(f.get('amount')) : null, startDate: f.get('startDate') || null, dueDate: f.get('dueDate') || null, hostAccountId: newHostId, service: activeService, paymentStatus: f.get('paymentStatus') || 'pending', notes: f.get('notes') || null }; try { showLoading(true, 'Updating...'); await updateCustomerInDB(upd); var idx = customers[activeService].findIndex(c => c.id === id); if (idx !== -1) customers[activeService][idx] = upd; if (oldHostId !== newHostId) { if (oldHostId) { var ohi = hostAccounts[activeService].findIndex(h => h.id === oldHostId); if (ohi !== -1) hostAccounts[activeService][ohi].customers = hostAccounts[activeService][ohi].customers.filter(x => x !== id); } if (newHostId) { var nhi = hostAccounts[activeService].findIndex(h => h.id === newHostId); if (nhi !== -1 && !hostAccounts[activeService][nhi].customers.includes(id)) hostAccounts[activeService][nhi].customers.push(id); } } closeModal('editCustomer'); render(); showLoading(false); showToast('‚úì Updated!', 'success'); } catch (err) { showLoading(false); showToast('Failed', 'error'); } }
    
    async function addHost(e) { e.preventDefault(); var f = new FormData(e.target), s = f.get('startDate') || null, dur = parseInt(f.get('duration')) || 1, d = s ? calculateDueDate(s, dur) : null, cost = f.get('cost') ? parseFloat(f.get('cost')) : SERVICES[activeService].price, max = f.get('maxUsers') ? parseInt(f.get('maxUsers')) : 5; var nh = { id: generateId(), email: f.get('email') || null, cost: cost, maxUsers: max, customers: [], startDate: s, dueDate: d, service: activeService }; try { showLoading(true, 'Adding...'); await addHostToDB(nh); hostAccounts[activeService].push(nh); closeModal('addHost'); render(); showLoading(false); showToast('‚úì Added!', 'success'); } catch (err) { showLoading(false); showToast('Failed: ' + err.message, 'error'); } }
    
    async function updateHost(e) { e.preventDefault(); var f = new FormData(e.target), id = f.get('id'), old = hostAccounts[activeService].find(h => h.id === id); if (!old) return; var upd = { id: id, email: f.get('email') || null, cost: f.get('cost') ? parseFloat(f.get('cost')) : SERVICES[activeService].price, maxUsers: f.get('maxUsers') ? parseInt(f.get('maxUsers')) : 5, startDate: f.get('startDate') || null, dueDate: f.get('dueDate') || null, service: activeService, customers: old.customers }; try { showLoading(true, 'Updating...'); await updateHostInDB(upd); var idx = hostAccounts[activeService].findIndex(h => h.id === id); if (idx !== -1) hostAccounts[activeService][idx] = upd; closeModal('editHost'); render(); showLoading(false); showToast('‚úì Updated!', 'success'); } catch (err) { showLoading(false); showToast('Failed', 'error'); } }
    
    async function deleteCustomer(id) { if (!confirm('Delete this customer?')) return; try { showLoading(true, 'Deleting...'); await deleteCustomerFromDB(id); var c = customers[activeService].find(x => x.id === id); customers[activeService] = customers[activeService].filter(x => x.id !== id); if (c && c.hostAccountId) { var hi = hostAccounts[activeService].findIndex(h => h.id === c.hostAccountId); if (hi !== -1) hostAccounts[activeService][hi].customers = hostAccounts[activeService][hi].customers.filter(x => x !== id); } selectedCustomers.delete(id); updateBulkActionsBar(); render(); showLoading(false); showToast('‚úì Deleted!', 'success'); } catch (err) { showLoading(false); showToast('Failed', 'error'); } }
    
    async function deleteHost(id) { if (!confirm('Delete this host?')) return; try { showLoading(true, 'Deleting...'); await deleteHostFromDB(id); var h = hostAccounts[activeService].find(x => x.id === id); if (h) customers[activeService].forEach(c => { if (h.customers.includes(c.id)) c.hostAccountId = null; }); hostAccounts[activeService] = hostAccounts[activeService].filter(x => x.id !== id); render(); showLoading(false); showToast('‚úì Deleted!', 'success'); } catch (err) { showLoading(false); showToast('Failed', 'error'); } }
    
    async function renewCustomer(id) { var i = customers[activeService].findIndex(c => c.id === id); if (i !== -1) { var s = new Date().toISOString().split('T')[0], d = calculateDueDate(new Date(), 1); try { showLoading(true, 'Renewing...'); await renewCustomerInDB(id, s, d); customers[activeService][i].startDate = s; customers[activeService][i].dueDate = d; customers[activeService][i].paymentStatus = 'pending'; render(); showLoading(false); showToast('‚úì Renewed!', 'success'); } catch (err) { showLoading(false); showToast('Failed', 'error'); } } }
    
    async function renewHost(id) { var i = hostAccounts[activeService].findIndex(h => h.id === id); if (i !== -1) { var s = new Date().toISOString().split('T')[0], d = calculateDueDate(new Date(), 1); try { showLoading(true, 'Renewing...'); await renewHostInDB(id, s, d); hostAccounts[activeService][i].startDate = s; hostAccounts[activeService][i].dueDate = d; render(); showLoading(false); showToast('‚úì Renewed!', 'success'); } catch (err) { showLoading(false); showToast('Failed', 'error'); } } }

    // ============================================
    // INITIALIZE ON PAGE LOAD
    // ============================================
    document.addEventListener('DOMContentLoaded', checkAuth);
  </script>
</body>
</html>
